<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="追憶" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    
    <title>PHP文件上传类(支持单文件上传，也支持多文件上传)</title>
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/atom.xml" rel="alternate" title="世间自古有情痴" type="application/atom+xml" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/media/css/style.css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/retina.js/1.3.0/retina.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script type="text/javascript"> hljs.initHighlightingOnLoad(); </script>
  </head>
  <body>
      <div id="main" role="main">
        <header>
          <div id="header">
            <h1><a title="世间自古有情痴" class="" href="/">世间自古有情痴</a></h1>
          </div>
          <nav>
            
            <span><a title="Archive" href="/archive.html"><i class="fa fa-list-ul"></i></a></span>
            
            <span><a title="Tags" href="/tags.html"><i class="fa fa-tags"></i></a></span>
            
            <span><a title="About" href="/about.html"><i class="fa fa-user"></i></a></span>
            
            <span><a title="Gallery" href="http://www.tianhui.site"><i class="fa fa-film"></i></a></span>
            
            <span><a title="Subscribe" href="/atom.xml"><i class="fa fa-rss"></i></a></span>
            
          </nav>
        </header>
        <div id="content">
        <article>
  <section class="title">
    <h2>PHP文件上传类(支持单文件上传，也支持多文件上传) </h2>
  </section>
  <section class="meta">
  <span class="time">
    <time datetime="2015-10-03">2015-10-03</time>
  </span>
  
  <span class="tags">
    
    <a href="/tags.html#php" title="php">#php</a>
    
  </span>
  <!-- BEGIN this would not work on any other domain -->
  <span
    class           = "like-wrapper"
    like-shortname  = 'gopherwood'
    like-identifier = 'urn:uuid:b87da13a-a4dd-402f-b06a-cef7eeee2d80'
    like-name       = 'PHP文件上传类(支持单文件上传，也支持多文件上传)'
    like-btn        = '&#xf087;'
    like-link       = 'https://zhuiyi1997.github.io//2015/10/03/fileclass.html'
    ></span>
  <script type="text/javascript">
    var l = document.createElement('script');
    l.type = 'text/javascript'; l.async = true; l.src = 'http://www.like-btn.com/javascript/widget.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(l);
  </script>
  <!-- END this would not work on any other domain -->
  
  </section>
  <section class="post">
  <hr />
<!-- more -->

<p>```
&lt;?php<br />
  /**
    file: fileupload.class.php 文件上传类FileUpload 
    本类的实例对象用于处理上传文件，可以上传一个文件，也可同时处理多个文件上传 
  */<br />
  class FileUpload { <br />
    private $path = “./uploads”;          //上传文件保存的路径<br />
    private $allowtype = array(‘jpg’,’gif’,’png’); //设置限制上传文件的类型<br />
    private $maxsize = 1000000;           //限制文件上传大小（字节）<br />
    private $israndname = true;           //设置是否随机重命名文件， false不随机</p>

<pre><code>private $originName;              //源文件名  
private $tmpFileName;              //临时文件名  
private $fileType;               //文件类型(文件后缀)  
private $fileSize;               //文件大小  
private $newFileName;              //新文件名  
private $errorNum = 0;             //错误号  
private $errorMess="";             //错误报告消息  
   
/** 
 * 用于设置成员属性（$path, $allowtype,$maxsize, $israndname） 
 * 可以通过连贯操作一次设置多个属性值 
 *@param  string $key  成员属性名(不区分大小写) 
 *@param  mixed  $val  为成员属性设置的值 
 *@return  object     返回自己对象$this，可以用于连贯操作 
 */  
function set($key, $val){  
  $key = strtolower($key);   
  if( array_key_exists( $key, get_class_vars(get_class($this) ) ) ){  
    $this-&gt;setOption($key, $val);  
  }  
  return $this;  
}  
   
/** 
 * 调用该方法上传文件 
 * @param  string $fileFile  上传文件的表单名称  
 * @return bool        如果上传成功返回数true  
 */  
   
function upload($fileField) {  
  $return = true;  
  /* 检查文件路径是滞合法 */  
  if( !$this-&gt;checkFilePath() ) {         
    $this-&gt;errorMess = $this-&gt;getError();  
    return false;  
  }  
  /* 将文件上传的信息取出赋给变量 */  
  $name = $_FILES[$fileField]['name'];  
  $tmp_name = $_FILES[$fileField]['tmp_name'];  
  $size = $_FILES[$fileField]['size'];  
  $error = $_FILES[$fileField]['error'];  
   
  /* 如果是多个文件上传则$file["name"]会是一个数组 */  
  if(is_Array($name)){      
    $errors=array();  
    /*多个文件上传则循环处理 ， 这个循环只有检查上传文件的作用，并没有真正上传 */  
    for($i = 0; $i &lt; count($name); $i++){   
      /*设置文件信息 */  
      if($this-&gt;setFiles($name[$i],$tmp_name[$i],$size[$i],$error[$i] )) {  
        if(!$this-&gt;checkFileSize() || !$this-&gt;checkFileType()){  
          $errors[] = $this-&gt;getError();  
          $return=false;   
        }  
      }else{  
        $errors[] = $this-&gt;getError();  
        $return=false;  
      }  
      /* 如果有问题，则重新初使化属性 */  
      if(!$return)            
        $this-&gt;setFiles();  
    }  
   
    if($return){  
      /* 存放所有上传后文件名的变量数组 */  
      $fileNames = array();        
      /* 如果上传的多个文件都是合法的，则通过销魂循环向服务器上传文件 */  
      for($i = 0; $i &lt; count($name); $i++){   
        if($this-&gt;setFiles($name[$i], $tmp_name[$i], $size[$i], $error[$i] )) {  
          $this-&gt;setNewFileName();   
          if(!$this-&gt;copyFile()){  
            $errors[] = $this-&gt;getError();  
            $return = false;  
          }  
          $fileNames[] = $this-&gt;newFileName;    
        }            
      }  
      $this-&gt;newFileName = $fileNames;  
    }  
    $this-&gt;errorMess = $errors;  
    return $return;  
  /*上传单个文件处理方法*/  
  } else {  
    /* 设置文件信息 */  
    if($this-&gt;setFiles($name,$tmp_name,$size,$error)) {  
      /* 上传之前先检查一下大小和类型 */  
      if($this-&gt;checkFileSize() &amp;&amp; $this-&gt;checkFileType()){   
        /* 为上传文件设置新文件名 */  
        $this-&gt;setNewFileName();   
        /* 上传文件  返回0为成功， 小于0都为错误 */  
        if($this-&gt;copyFile()){   
          return true;  
        }else{  
          $return=false;  
        }  
      }else{  
        $return=false;  
      }  
    } else {  
      $return=false;   
    }  
    //如果$return为false, 则出错，将错误信息保存在属性errorMess中  
    if(!$return)  
      $this-&gt;errorMess=$this-&gt;getError();    
   
    return $return;  
  }  
}  
   
/**  
 * 获取上传后的文件名称 
 * @param  void   没有参数 
 * @return string 上传后，新文件的名称， 如果是多文件上传返回数组 
 */  
public function getFileName(){  
  return $this-&gt;newFileName;  
}  
   
/** 
 * 上传失败后，调用该方法则返回，上传出错信息 
 * @param  void   没有参数 
 * @return string  返回上传文件出错的信息报告，如果是多文件上传返回数组 
 */  
public function getErrorMsg(){  
  return $this-&gt;errorMess;  
}  
   
/* 设置上传出错信息 */  
private function getError() {  
  $str = "上传文件&lt;font color='red'&gt;{$this-&gt;originName}&lt;/font&gt;时出错 : ";  
  switch ($this-&gt;errorNum) {  
    case 4: $str .= "没有文件被上传"; break;  
    case 3: $str .= "文件只有部分被上传"; break;  
    case 2: $str .= "上传文件的大小超过了HTML表单中MAX_FILE_SIZE选项指定的值"; break;  
    case 1: $str .= "上传的文件超过了php.ini中upload_max_filesize选项限制的值"; break;  
    case -1: $str .= "未允许类型"; break;  
    case -2: $str .= "文件过大,上传的文件不能超过{$this-&gt;maxsize}个字节"; break;  
    case -3: $str .= "上传失败"; break;  
    case -4: $str .= "建立存放上传文件目录失败，请重新指定上传目录"; break;  
    case -5: $str .= "必须指定上传文件的路径"; break;  
    default: $str .= "未知错误";  
  }  
  return $str.'&lt;br&gt;';  
}  
   
/* 设置和$_FILES有关的内容 */  
private function setFiles($name="", $tmp_name="", $size=0, $error=0) {  
  $this-&gt;setOption('errorNum', $error);  
  if($error)  
    return false;  
  $this-&gt;setOption('originName', $name);  
  $this-&gt;setOption('tmpFileName',$tmp_name);  
  $aryStr = explode(".", $name);  
  $this-&gt;setOption('fileType', strtolower($aryStr[count($aryStr)-1]));  
  $this-&gt;setOption('fileSize', $size);  
  return true;  
}  
   
/* 为单个成员属性设置值 */  
private function setOption($key, $val) {  
  $this-&gt;$key = $val;  
}  
   
/* 设置上传后的文件名称 */  
private function setNewFileName() {  
  if ($this-&gt;israndname) {  
    $this-&gt;setOption('newFileName', $this-&gt;proRandName());    
  } else{   
    $this-&gt;setOption('newFileName', $this-&gt;originName);  
  }   
}  
   
/* 检查上传的文件是否是合法的类型 */  
private function checkFileType() {  
  if (in_array(strtolower($this-&gt;fileType), $this-&gt;allowtype)) {  
    return true;  
  }else {  
    $this-&gt;setOption('errorNum', -1);  
    return false;  
  }  
}  
   
/* 检查上传的文件是否是允许的大小 */  
private function checkFileSize() {  
  if ($this-&gt;fileSize &gt; $this-&gt;maxsize) {  
    $this-&gt;setOption('errorNum', -2);  
    return false;  
  }else{  
    return true;  
  }  
}  
   
/* 检查是否有存放上传文件的目录 */  
private function checkFilePath() {  
  if(empty($this-&gt;path)){  
    $this-&gt;setOption('errorNum', -5);  
    return false;  
  }  
  if (!file_exists($this-&gt;path) || !is_writable($this-&gt;path)) {  
    if (!@mkdir($this-&gt;path, 0755)) {  
      $this-&gt;setOption('errorNum', -4);  
      return false;  
    }  
  }  
  return true;  
}  
   
/* 设置随机文件名 */  
private function proRandName() {      
  $fileName = date('YmdHis')."_".rand(100,999);      
  return $fileName.'.'.$this-&gt;fileType;   
}  
   
/* 复制上传文件到指定的位置 */  
private function copyFile() {  
  if(!$this-&gt;errorNum) {  
    $path = rtrim($this-&gt;path, '/').'/';  
    $path .= $this-&gt;newFileName;  
    if (@move_uploaded_file($this-&gt;tmpFileName, $path)) {  
      return true;  
    }else{  
      $this-&gt;setOption('errorNum', -3);  
      return false;  
    }  
  } else {  
    return false;  
  }  
}     }   ``` **文件上传类的应用过程：**
</code></pre>

<p>本列的文件上传类FileUpload，不仅支持单文件上传，也支持多文件上传。
  在处理方式上没有区别，只不过在编写上传表单时，多个文件上传一定要以数组方式传递给服务器。
  单个文件上传表单如下所示：</p>

<p><img src="/res/img/blog/PHP学习/fileClass_1.jpg" alt="fileClass_1" /></p>

<p>上面表单都是，都将提交的位置指向了同一个文件upload.php，
  所以不难看出单个和多个文件上传是一样的处理方式，upload.php代码如下所示：
```
      &lt;?php<br />
      //包含一个文件上传类中的上传类<br />
      include “fileupload.class.php”;</p>

<pre><code>  $up = new fileupload;  
  //设置属性(上传的位置， 大小， 类型， 名是是否要随机生成)  
  $up -&gt; set("path", "./images/");  
  $up -&gt; set("maxsize", 2000000);  
  $up -&gt; set("allowtype", array("gif", "png", "jpg","jpeg"));  
  $up -&gt; set("israndname", false);  
 
  //使用对象中的upload方法， 就可以上传文件， 方法需要传一个上传表单的名子 pic, 如果成功返回true, 失败返回false  
  if($up -&gt; upload("pic")) {  
      echo '&lt;pre&gt;';  
      //获取上传后文件名子  
      var_dump($up-&gt;getFileName());  
      echo '&lt;/pre&gt;';  
 
  } else {  
      echo '&lt;pre&gt;';  
      //获取上传失败以后的错误提示  
      var_dump($up-&gt;getErrorMsg());  
      echo '&lt;/pre&gt;';  
  }     ?&gt;&lt;span id="transmark" style="display: none; width: 0px; height: 0px;"&gt;&lt;/span&gt;   ```
</code></pre>


  </section>
  
  <div class="divider">
    <span>
    
    <a href="/2015/10/01/dbclass.html"><i class="fa fa-chevron-left"></i></a>
    
    </span>
    <!-- BEGIN comment icon
    <span><a href="javascript:leave_comment();" id="leave_comment_link"><i class="fa fa-comment-o"></i></a></span>
    <span><a href="javascript:collapse_comment();" id="collapse_comment_link" style="display:none;"><i class="fa fa-chevron-up"></i></a></span>
      END comment icon -->

    <span>
    
    <a href="/2015/10/03/nodejs.html"><i class="fa fa-chevron-right"></i></a>
    
    </span>
  </div>

  <!-- BEGIN comment
  <section class="comment">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'gopherwood';
      var disqus_identifier = 'urn:uuid:b87da13a-a4dd-402f-b06a-cef7eeee2d80';

      function leave_comment() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          $("#leave_comment_link").css("display", "none");
          $("#collapse_comment_link").css("display", "");
      };
      function collapse_comment() {
          // document.getElementById("disqus_thread").innerHTML = '';
          $("#disqus_thread").slideUp(400, function() {
              $("#disqus_thread").empty();
              $("#leave_comment_link").css("display", "");
              $("#collapse_comment_link").css("display", "none");
              $("#disqus_thread").css("display", "");
          });
      };
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </section>
  END comment -->
  
</article>

        </div>
        <footer>
          <div>
            
            &copy; 2013 ~ 2017 追憶 | powered by jekyll | themed by <a href="http://www.tianhui.site" title="sext vi">sext vi</a> | fork <a href="https://github.com/zhuiyi1997" title="fork me">me</a>
          </div>
        </footer>
      </div> <!-- main -->
  </body>
</html>
